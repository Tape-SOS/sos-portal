<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reporte SOS</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--fg:#111;--bg:#fff;--accent:#277771;--muted:#666;--error:#b00020;--ok:#0a7d2f}
    @media (prefers-color-scheme: dark){
      :root{--fg:#eee;--bg:#111;--muted:#aaa}
      input,select,button,textarea{background:#1b1b1b;color:var(--fg);border-color:#333}
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg);max-width:640px;margin:24px auto;padding:0 16px;line-height:1.35}
    header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin:14px 0}
    .lang-switch{display:flex;gap:6px;flex-wrap:wrap}
    .lang-btn{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #e0e0e0;border-radius:999px;background:#fff;cursor:pointer;font-size:.9rem}
    .lang-btn.active{border-color:var(--accent)}
    .flag{font-size:1.1rem;line-height:1}
    h1{font-size:1.4rem;margin:.5rem 0 1rem}
    form{border:1px solid #e6e6e6;border-radius:12px;padding:16px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    .req::after{content:" *";color:var(--accent);font-weight:700}
    input,select,button,textarea{width:100%;padding:12px;border:1px solid #d7d7d7;border-radius:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-tel{display:grid;grid-template-columns:minmax(120px,160px) 1fr;gap:10px}
    .hint{font-size:.85rem;color:var(--muted);margin-top:4px}
    .actions{display:flex;gap:10px;align-items:center;margin-top:8px}
    .actions button{flex:1}
    .ghost{background:transparent;border-style:dashed}
    .badge{display:inline-block;font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid #e6e6e6;color:var(--muted)}
    #msg{margin-top:14px;font-weight:600}
    .ok{color:var(--ok)}
    .err{color:var(--error)}
    .muted{color:var(--muted)}
    .maplink{margin-top:6px;display:inline-block}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    .footer{margin-top:14px;font-size:.85rem;color:var(--muted)}
    .spinner{inline-size:1em;block-size:1em;border:.18em solid #ccc;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-.2em;animation:s 0.8s linear infinite}
    @keyframes s{to{transform:rotate(1turn)}}

    /* Barra de √≠conos sociales */
    .social {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .social a {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid #e0e0e0;
      text-decoration: none;
    }
    .social a:hover { box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent); }
    .social svg { width: 22px; height: 22px; }
    @media (prefers-color-scheme: dark){
      .social a { background:#1b1b1b; border-color:#333; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 id="t_title">Reportar evento SOS</h1>
      <p class="hint" id="t_intro">Comparte tu ubicaci√≥n para enviar ayuda m√°s r√°pido. Tus datos se usar√°n solo para gestionar este reporte.</p>
    </div>
    <nav class="lang-switch" aria-label="Idioma / Language">
      <button class="lang-btn" data-lang="es" title="Espa√±ol"><span class="flag">üá™üá∏</span><span>Espa√±ol</span></button>
      <button class="lang-btn" data-lang="en" title="English"><span class="flag">üá∫üá∏</span><span>English</span></button>
      <button class="lang-btn" data-lang="pt" title="Portugu√™s"><span class="flag">üáßüá∑</span><span>Portugu√™s</span></button>
      <button class="lang-btn" data-lang="gn" title="Ava√±e'·∫Ω (Guaran√≠)"><span class="flag">üáµüáæ</span><span>Guaran√≠</span></button>
      <button class="lang-btn" data-lang="de" title="Deutsch"><span class="flag">üá©üá™</span><span>Deutsch</span></button>
    </nav>
  </header>

  <form id="f" novalidate aria-describedby="formHint">
    <div class="sr-only" id="formHint">Todos los campos marcados con * son obligatorios.</div>

    <label for="nombre" id="lbl_nombre">Nombre</label>
    <input id="nombre" name="nombre" placeholder="Tu nombre" autocomplete="name" inputmode="text" maxlength="80"/>

    <label class="req" id="lbl_tel">Tel√©fono</label>
    <div class="row-tel">
      <select id="codPais" name="codPais" aria-label="C√≥digo de pa√≠s">
        <option value="+595" selected>PY (+595)</option>
        <option value="+55">BR (+55)</option>
        <option value="+54">AR (+54)</option>
        <option value="+598">UY (+598)</option>
        <option value="+591">BO (+591)</option>
      </select>
      <input id="telefono" name="telefono" type="tel" placeholder="981 123 456" autocomplete="tel"
             required pattern="^\d{6,11}$" aria-describedby="telHint">
    </div>
    <div class="hint" id="telHint">
      Escribe solo el n√∫mero local (sin 0, sin +). Se marcar√° como <code id="phonePreview">+595 981 123 456</code>.
    </div>

    <label for="tipo" class="req" id="lbl_tipo">Tipo de evento</label>
    <select id="tipo" name="tipo" required>
      <!-- values internas estables; textos se traducen -->
      <option value="">Selecciona‚Ä¶</option>
      <option value="Accidente">Accidente</option>
      <option value="Mecanico">Problema mec√°nico</option>
      <option value="Otro">Otro</option>
    </select>

    <!-- Campo condicional: ¬øHay heridos? -->
    <div id="grupoHeridos" hidden>
      <label for="heridos" class="req" id="lbl_heridos">¬øHay heridos?</label>
      <select id="heridos" name="heridos" aria-live="polite">
        <option value="">Selecciona‚Ä¶</option>
        <option value="si">Si</option>
        <option value="no">No</option>
      </select>
    </div>

    <label for="detalle" id="lbl_detalle">Detalle (opcional)</label>
    <textarea id="detalle" name="detalle" rows="3" placeholder="Describe brevemente lo ocurrido (m√°x. 300 caracteres)" maxlength="300"></textarea>

    <div class="actions">
      <button type="button" id="btnUbic">üìç Obtener ubicaci√≥n</button>
      <span id="gpsStatus" class="badge">GPS: sin capturar</span>
    </div>

    <div class="row" aria-live="polite">
      <div>
        <label for="lat" id="lbl_lat">Latitud (auto)</label>
        <input id="lat" name="lat" placeholder="Latitud" readonly inputmode="numeric">
      </div>
      <div>
        <label for="lng" id="lbl_lng">Longitud (auto)</label>
        <input id="lng" name="lng" placeholder="Longitud" readonly inputmode="numeric">
      </div>
    </div>

    <a id="mapaLink" class="maplink muted" href="#" target="_blank" rel="noopener" hidden>Ver ubicaci√≥n en Google Maps ‚Üó</a>

    <div class="actions">
      <button type="submit" id="btnEnviar">Enviar</button>
      <button type="reset" class="ghost" id="btnLimpiar">Limpiar</button>
    </div>

    <p id="msg" role="status" aria-live="polite"></p>
    <input type="hidden" id="requestId">
    <input type="hidden" id="timestamp">
    <input type="hidden" id="mapaUrl">
  </form>

  <p class="footer" id="t_footer">Si el formulario falla, llama al <strong>+595 973 500767</strong> o escribe por WhatsApp haciendo <strong>clic aqu√≠</strong>.</p>

  <!-- Barra de √≠conos sociales -->
  <div class="social" aria-label="Redes sociales">
    <!-- Instagram -->
    <a href="https://www.instagram.com/tapeporapy/?hl=es" target="_blank" rel="noopener" aria-label="Instagram">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm10 2H7a3 3 0 0 0-3 3v10a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3zm-5 3.5A5.5 5.5 0 1 1 6.5 13 5.5 5.5 0 0 1 12 7.5zm0 2A3.5 3.5 0 1 0 15.5 13 3.5 3.5 0 0 0 12 9.5zM17.8 6.2a1 1 0 1 1-1.6 1.2 1 1 0 0 1 1.6-1.2z"/>
      </svg>
    </a>
    <!-- Facebook -->
    <a href="https://www.facebook.com/tapepora/?locale=es_LA" target="_blank" rel="noopener" aria-label="Facebook">
      <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M22 12a10 10 0 1 0-11.6 9.9v-7H7.9V12h2.5V9.8c0-2.5 1.5-3.9 3.7-3.9 1.1 0 2.2.2 2.2.2v2.4h-1.2c-1.2 0-1.6.8-1.6 1.5V12h2.8l-.45 2.9h-2.35v7A10 10 0 0 0 22 12z"/>
      </svg>
    </a>
    <!-- WhatsApp -->
  <a href="https://api.whatsapp.com/send?phone=595973500767&text=%C2%A1Hola!%20Escribo%20para%20solicitar%20asistencia%20%F0%9F%86%98" target="_blank" rel="noopener" aria-label="WhatsApp">
    <!-- √≠cono WhatsApp (SVG) -->
    <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M.057 24l1.687-6.163A11.867 11.867 0 0 1 0 11.993C0 5.372 5.373 0 11.994 0 18.616 0 24 5.372 24 11.993c0 6.622-5.384 11.995-12.006 11.995-2.043 0-4.042-.513-5.824-1.487L.057 24zm6.597-3.807c1.676.995 3.276 1.591 5.35 1.591 5.45 0 9.89-4.437 9.89-9.89 0-5.45-4.44-9.887-9.89-9.887-5.452 0-9.89 4.437-9.89 9.888 0 2.114.69 4.083 1.852 5.69l-.79 2.89 3.478-.972zM17.53 14.47c-.074-.123-.27-.198-.563-.347-.295-.148-1.748-.861-2.019-.959-.27-.099-.467-.148-.663.148-.197.296-.761.959-.934 1.155-.172.198-.344.223-.637.074-.295-.148-1.243-.458-2.366-1.46-.875-.78-1.467-1.742-1.64-2.038-.172-.296-.018-.456.13-.604.133-.132.296-.344.444-.516.148-.172.197-.296.296-.494.099-.197.05-.371-.025-.52-.074-.148-.663-1.598-.909-2.186-.24-.58-.484-.5-.663-.51l-.566-.01c-.197 0-.52.074-.792.371-.27.296-1.04 1.017-1.04 2.479s1.065 2.876 1.213 3.074c.148.197 2.095 3.2 5.076 4.487.71.306 1.263.489 1.694.626.712.227 1.36.195 1.872.118.571-.085 1.748-.713 1.995-1.402.246-.69.246-1.282.172-1.402z"/>
    </svg>
  </a>
  </div>

  <script>
  // === CONFIG ===
  const endpoint = "https://default688a0fce5571499b9b5a8fef12ae5c.08.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/540a67fb821042ce9a9c009ac064975c/triggers/manual/paths/invoke/?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=b3_sZEJJEMWiK_myP_QktIK34z9U2pcPjhTJX0GukK8"; // tu endpoint de Power Automate
  const FETCH_TIMEOUT_MS = 12000;
  const GPS_TIMEOUT_MS = 10000;
  const GPS_MAX_AGE_MS = 15000;

  // === I18N DICTIONARY ===
  const I18N = {
    es: {
      title: "Reportar evento SOS",
      intro: "Comparte tu ubicaci√≥n para enviar ayuda m√°s r√°pido. Tus datos se usar√°n solo para gestionar este reporte.",
      formHint: "Todos los campos marcados con * son obligatorios.",
      nombre: "Nombre",
      telefono: "Tel√©fono",
      telHint: "Escribe solo el n√∫mero local (sin 0, sin +). Se marcar√° como",
      tipo: "Tipo de evento",
      tipo_opts: { blank:"Selecciona‚Ä¶", Accidente:"Accidente", Mecanico:"Problema mec√°nico", Otro:"Otro" },
      heridos: "¬øHay heridos?",
      heridos_opts: { blank:"Selecciona‚Ä¶", si:"Si", no:"No" },
      detalle: "Detalle (opcional)",
      detalle_ph: "Describe brevemente lo ocurrido (m√°x. 300 caracteres)",
      btnUbic: "üìç Obtener ubicaci√≥n",
      gpsInit: "GPS: sin capturar",
      gpsBusy: "GPS: buscando‚Ä¶",
      gpsOk: acc => `GPS: OK (¬±${acc} m)`,
      gpsErr: "No se pudo obtener tu ubicaci√≥n. Puedes reintentar o enviar sin ubicaci√≥n.",
      lat: "Latitud (auto)",
      lng: "Longitud (auto)",
      mapText: "Ver ubicaci√≥n en Google Maps ‚Üó",
      enviar: "Enviar",
      limpiar: "Limpiar",
      sending: "Enviando‚Ä¶",
      msgOk: "¬°Reporte enviado correctamente! La ayuda va en camino.",
      msgPrep: "Preparando env√≠o‚Ä¶",
      msgTipoReq: "Selecciona el tipo de evento.",
      msgHeridosReq: "Indica si hay heridos.",
      msgTelReq: "Ingresa un n√∫mero local v√°lido (6 a 11 d√≠gitos).",
      ubicOk: "Ubicaci√≥n capturada correctamente.",
      ubicNoGeo: "Tu navegador no permite geolocalizaci√≥n.",
      footer: 'Si el formulario falla, llama al <strong>+595 973 500767</strong> o escribe por WhatsApp haciendo <a href="https://api.whatsapp.com/send?phone=595973500767&text=%C2%A1Hola!%20Escribo%20para%20solicitar%20asistencia%20%F0%9F%86%98" target="_blank" rel="noopener"><strong>clic aqu√≠</strong></a>.',
      name_ph: "Tu nombre",
      phone_preview_prefix: ""
    },
    en: {
      title: "Report SOS Event",
      intro: "Share your location to send help faster. Your data is used only to manage this report.",
      formHint: "All fields marked with * are required.",
      nombre: "Name",
      telefono: "Phone",
      telHint: "Type only the local number (no 0, no +). It will be formatted as",
      tipo: "Event type",
      tipo_opts: { blank:"Select‚Ä¶", Accidente:"Accident", Mecanico:"Mechanical issue", Otro:"Other" },
      heridos: "Are there injuries?",
      heridos_opts: { blank:"Select‚Ä¶", si:"Yes", no:"No" },
      detalle: "Details (optional)",
      detalle_ph: "Briefly describe what happened (max 300 characters)",
      btnUbic: "üìç Get location",
      gpsInit: "GPS: not captured",
      gpsBusy: "GPS: locating‚Ä¶",
      gpsOk: acc => `GPS: OK (¬±${acc} m)`,
      gpsErr: "Could not get your location. You can retry or submit without it.",
      lat: "Latitude (auto)",
      lng: "Longitude (auto)",
      mapText: "Open in Google Maps ‚Üó",
      enviar: "Submit",
      limpiar: "Clear",
      sending: "Sending‚Ä¶",
      msgOk: "Report sent successfully! Help is on the way.",
      msgPrep: "Preparing submission‚Ä¶",
      msgTipoReq: "Select the event type.",
      msgHeridosReq: "Please indicate if there are injuries.",
      msgTelReq: "Enter a valid local number (6 to 11 digits).",
      ubicOk: "Location captured successfully.",
      ubicNoGeo: "Your browser does not allow geolocation.",
      footer: 'If the form fails, call <strong>+595 973 500767</strong> or send a WhatsApp message: <a href="https://api.whatsapp.com/send?phone=595973500767&text=%C2%A1Hola!%20Escribo%20para%20solicitar%20asistencia%20%F0%9F%86%98" target="_blank" rel="noopener"><strong>Click here</strong></a>.',
      name_ph: "Your name",
      phone_preview_prefix: ""
    },
    pt: {
      title: "Reportar ocorr√™ncia SOS",
      intro: "Compartilhe sua localiza√ß√£o para enviar ajuda mais r√°pido. Seus dados ser√£o usados apenas para este reporte.",
      formHint: "Todos os campos marcados com * s√£o obrigat√≥rios.",
      nombre: "Nome",
      telefono: "Telefone",
      telHint: "Digite apenas o n√∫mero local (sem 0, sem +). Ser√° formatado como",
      tipo: "Tipo de ocorr√™ncia",
      tipo_opts: { blank:"Selecione‚Ä¶", Accidente:"Acidente", Mecanico:"Problema mec√¢nico", Otro:"Outro" },
      heridos: "H√° feridos?",
      heridos_opts: { blank:"Selecione‚Ä¶", si:"Sim", no:"N√£o" },
      detalle: "Detalhe (opcional)",
      detalle_ph: "Descreva brevemente o ocorrido (m√°x. 300 caracteres)",
      btnUbic: "üìç Obter localiza√ß√£o",
      gpsInit: "GPS: n√£o capturado",
      gpsBusy: "GPS: buscando‚Ä¶",
      gpsOk: acc => `GPS: OK (¬±${acc} m)`,
      gpsErr: "N√£o foi poss√≠vel obter sua localiza√ß√£o. Tente novamente ou envie sem localiza√ß√£o.",
      lat: "Latitude (auto)",
      lng: "Longitude (auto)",
      mapText: "Ver no Google Maps ‚Üó",
      enviar: "Enviar",
      limpiar: "Limpar",
      sending: "Enviando‚Ä¶",
      msgOk: "Reporte enviado com sucesso! A ajuda est√° a caminho.",
      msgPrep: "Preparando envio‚Ä¶",
      msgTipoReq: "Selecione o tipo de ocorr√™ncia.",
      msgHeridosReq: "Informe se h√° feridos.",
      msgTelReq: "Digite um n√∫mero local v√°lido (6 a 11 d√≠gitos).",
      ubicOk: "Localiza√ß√£o capturada com sucesso.",
      ubicNoGeo: "Seu navegador n√£o permite geolocaliza√ß√£o.",
      footer: 'Se o formul√°rio falhar, ligue para <strong>+595 973 500767</strong> ou envie uma mensagem no WhatsApp <a href="https://api.whatsapp.com/send?phone=595973500767&text=%C2%A1Hola!%20Escribo%20para%20solicitar%20asistencia%20%F0%9F%86%98" target="_blank" rel="noopener"><strong>clicando aqui</strong></a>.',
      name_ph: "Seu nome",
      phone_preview_prefix: ""
    },
    gn: {
      title: "Emombe‚Äôu peteƒ© mba‚Äôe oiko va‚Äôekue (SOS)",
      intro: "Emoheraku√£ ne renda ojejapo pya‚Äôe‡≤ó‡≤æ‡≤ó‡≤ø pytyv√µ. Eipuruh√≠na ko marandu pe reporte a√±oite guar√£.",
      formHint: "Umi tenda ijuruj√°va * rehegua oikotev·∫Ω.",
      nombre: "T√©ra",
      telefono: "Pumbyry",
      telHint: "Ehai a√±oite pe papapy renda rehegua (ani 0, ani +). O√±emoha‚Äô√£nga ko‚Äô√£ichante",
      tipo: "Mba‚Äôe oiko va‚Äôekue",
      tipo_opts: { blank:"Eiporavo‚Ä¶", Accidente:"Jekaa", Mecanico:"Apopyre jejavy", Otro:"Ambue" },
      heridos: "¬øI√±apytyv√µr√£pa oƒ© (o√±embyai va‚Äôekue)?",
      heridos_opts: { blank:"Eiporavo‚Ä¶", si:"H√©·∫Ω", no:"Nah√°niri" },
      detalle: "Mba‚Äôemimi (jepy‚Äôapeteƒ©) ",
      detalle_ph: "Emombe‚Äôu mbykymi mba‚Äôe oiko va‚Äôekue (hetav√©vo 300 tai)",
      btnUbic: "üìç Erek√≥ta ne renda",
      gpsInit: "GPS: ndaip√≥ri gueteri",
      gpsBusy: "GPS: oheka‚Ä¶",
      gpsOk: acc => `GPS: oƒ© por√£ (¬±${acc} m)`,
      gpsErr: "Ndaikat√∫i ojuhu ne renda. Ikatu eha‚Äô√£ jey t√©r√£ emondo rendaha‚Äô·ªπre.",
      lat: "Latitud (auto)",
      lng: "Longitud (auto)",
      mapText: "Hecha Google Maps-pe ‚Üó",
      enviar: "Emondo",
      limpiar: "Mopotƒ©",
      sending: "O√±emondo‚Ä¶",
      msgOk: "Reporte o√±emond√≥ma por√£! O√∫tama pytyv√µ.",
      msgPrep: "O√±embosako‚Äôi √±emondo‚Ä¶",
      msgTipoReq: "Eiporavo mba‚Äôe oiko va‚Äôekue.",
      msgHeridosReq: "Emombe‚Äôu oƒ©pa o√±embyai va‚Äôekue.",
      msgTelReq: "Ehai papapy renda hekopete (6 guive 11 papapy peve).",
      ubicOk: "Renda ojepyta peteƒ©chapa.",
      ubicNoGeo: "Ne kundah√°ra ndohej√°iri geolocalizaci√≥n.",
      footer: 'Ndohupytyrir√µ pe kuatia√±e‚Äô·∫Ω, ehen√≥i <strong>+595 973 500767</strong>-pe t√©r√£ emondo WhatsApp <a href="https://api.whatsapp.com/send?phone=595973500767&text=%C2%A1Hola!%20Escribo%20para%20solicitar%20asistencia%20%F0%9F%86%98" target="_blank" rel="noopener"><strong>clic √°pe</strong></a>.',
      name_ph: "Nde r√©ra",
      phone_preview_prefix: ""
    },
    de: {
      title: "SOS-Ereignis melden",
      intro: "Teile deinen Standort, damit Hilfe schneller gesendet werden kann. Deine Daten werden nur zur Bearbeitung dieser Meldung verwendet.",
      formHint: "Alle mit * gekennzeichneten Felder sind Pflichtfelder.",
      nombre: "Name",
      telefono: "Telefon",
      telHint: "Nur die lokale Nummer eingeben (ohne 0, ohne +). Sie wird formatiert als",
      tipo: "Ereignistyp",
      tipo_opts: { blank:"Ausw√§hlen‚Ä¶", Accidente:"Unfall", Mecanico:"Technisches Problem", Otro:"Sonstiges" },
      heridos: "Gibt es Verletzte?",
      heridos_opts: { blank:"Ausw√§hlen‚Ä¶", si:"Ja", no:"Nein" },
      detalle: "Details (optional)",
      detalle_ph: "Beschreibe kurz, was passiert ist (max. 300 Zeichen)",
      btnUbic: "üìç Standort ermitteln",
      gpsInit: "GPS: nicht erfasst",
      gpsBusy: "GPS: wird ermittelt‚Ä¶",
      gpsOk: acc => `GPS: OK (¬±${acc} m)`,
      gpsErr: "Standort konnte nicht ermittelt werden. Erneut versuchen oder ohne senden.",
      lat: "Breite (auto)",
      lng: "L√§nge (auto)",
      mapText: "In Google Maps √∂ffnen ‚Üó",
      enviar: "Senden",
      limpiar: "Zur√ºcksetzen",
      sending: "Senden‚Ä¶",
      msgOk: "Meldung erfolgreich gesendet! Hilfe ist unterwegs.",
      msgPrep: "Sendevorgang wird vorbereitet‚Ä¶",
      msgTipoReq: "Bitte Ereignistyp w√§hlen.",
      msgHeridosReq: "Bitte angeben, ob es Verletzte gibt.",
      msgTelReq: "G√ºltige lokale Nummer eingeben (6‚Äì11 Ziffern).",
      ubicOk: "Standort erfolgreich erfasst.",
      ubicNoGeo: "Dein Browser erlaubt keine Geolokalisierung.",
      footer: 'Falls das Formular fehlschl√§gt, rufe <strong>+595 973 500767</strong> an oder schicke eine WhatsApp-Nachricht: <a href="https://api.whatsapp.com/send?phone=595973500767&text=%C2%A1Hola!%20Escribo%20para%20solicitar%20asistencia%20%F0%9F%86%98" target="_blank" rel="noopener"><strong>hier klicken</strong></a>.',
      name_ph: "Dein Name",
      phone_preview_prefix: ""
    }
  };

  // === HELPERS ===
  const $ = sel => document.querySelector(sel);
  const f = $('#f');
  const btnEnviar = $('#btnEnviar');
  const btnUbic = $('#btnUbic');
  const msg = $('#msg');
  const gpsStatus = $('#gpsStatus');
  const mapaLink = $('#mapaLink');
  const telInput = $('#telefono');
  const codeSelect = $('#codPais');
  const phonePreview = $('#phonePreview');
  const tipoSel = $('#tipo');
  const grupoHeridos = $('#grupoHeridos');
  const heridosSel = $('#heridos');
  const mapaUrlHidden = $('#mapaUrl');

  const HINTS = {
    '+595': '981 123 456',
    '+55': '11 91234 5678',
    '+54': '11 1234 5678',
    '+598': '92 123 456',
    '+591': '7 6123456'
  };

  // Estado de idioma
  let LANG = localStorage.getItem('lang') || 'es';

  function setMsg(text, kind=""){ msg.className = kind || "muted"; msg.innerHTML = text; }
  function setSendingState(s, tSend){
    btnEnviar.disabled = s; btnUbic.disabled = s;
    btnEnviar.innerHTML = s ? `<span class="spinner"></span> ${tSend}` : getT('enviar');
  }
  function uuid4(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;const v=c==='x'?r:(r&0x3|0x8);return v.toString(16);}); }
  function getT(key){ const t = I18N[LANG]?.[key]; return (typeof t === 'string') ? t : ''; }

  function normalizePhone(local, cc){
    let n = (local||'').replace(/\D/g,'').replace(/^0+/, '');
    return cc + n;
  }

  function updatePhoneUI(){
    const cc = codeSelect.value;
    const example = HINTS[cc] || '981 123 456';
    if(!telInput.value) telInput.placeholder = example;
    const digits = telInput.value.replace(/\D/g,'').replace(/^0+/, '');
    const pretty = digits.replace(/(\d{3,4})(?=\d)/g,'$1 ').trim();
    // Tel hint + preview
    $('#telHint').innerHTML = `${I18N[LANG].telHint} <code id="phonePreview">${cc} ${pretty || example}</code>.`;
  }

  // Campo condicional "¬øHay heridos?"
  function updateHeridos(){
    const esAccidente = (tipoSel.value === 'Accidente');
    grupoHeridos.hidden = !esAccidente;
    heridosSel.required = esAccidente;
    if(!esAccidente){ heridosSel.value = ''; }
  }

  // GEOLOCATION
  async function getLocation(){
    if(!('geolocation' in navigator)){ gpsStatus.textContent = I18N[LANG].gpsInit; setMsg(I18N[LANG].ubicNoGeo,'err'); return; }
    gpsStatus.textContent = I18N[LANG].gpsBusy; setMsg(I18N[LANG].gpsBusy,'muted');
    const opts = { enableHighAccuracy:true, timeout: GPS_TIMEOUT_MS, maximumAge: GPS_MAX_AGE_MS };
    const p = new Promise((resolve,reject)=>{ navigator.geolocation.getCurrentPosition(resolve,reject,opts); });
    try{
      const pos = await p;
      const { latitude, longitude, accuracy } = pos.coords;
      $('#lat').value = latitude.toFixed(6);
      $('#lng').value = longitude.toFixed(6);
      gpsStatus.textContent = I18N[LANG].gpsOk(Math.round(accuracy));
      updateMapLink($('#lat').value,$('#lng').value);
      setMsg(I18N[LANG].ubicOk,'ok');
    }catch{
      gpsStatus.textContent = I18N[LANG].gpsInit;
      setMsg(I18N[LANG].gpsErr,'err');
    }
  }

  function updateMapLink(lat,lng){
    if(lat && lng){
      const url = `https://www.google.com/maps?q=${lat},${lng}`;
      mapaLink.href = url;
      mapaLink.textContent = I18N[LANG].mapText;
      mapaLink.hidden = false;
      mapaLink.classList.remove('muted');
      mapaUrlHidden.value = url;
    }else{
      mapaLink.hidden = true;
      mapaUrlHidden.value = "";
    }
  }

  // === I18N APPLY ===
  function applyLang(){
    document.documentElement.setAttribute('lang', LANG);
    $('#t_title').textContent = I18N[LANG].title;
    $('#t_intro').textContent = I18N[LANG].intro;
    $('#formHint').textContent = I18N[LANG].formHint;
    $('#lbl_nombre').textContent = I18N[LANG].nombre;
    $('#lbl_tel').textContent = I18N[LANG].telefono;
    $('#lbl_tipo').textContent = I18N[LANG].tipo;
    $('#lbl_heridos').textContent = I18N[LANG].heridos;
    $('#lbl_detalle').textContent = I18N[LANG].detalle;
    $('#detalle').placeholder = I18N[LANG].detalle_ph;
    $('#btnUbic').textContent = I18N[LANG].btnUbic;
    gpsStatus.textContent = I18N[LANG].gpsInit;
    $('#lbl_lat').textContent = I18N[LANG].lat;
    $('#lbl_lng').textContent = I18N[LANG].lng;
    $('#mapaLink').textContent = I18N[LANG].mapText;
    btnEnviar.textContent = I18N[LANG].enviar;
    $('#btnLimpiar').textContent = I18N[LANG].limpiar;
    $('#t_footer').innerHTML = I18N[LANG].footer;
    $('#nombre').placeholder = I18N[LANG].name_ph;

    // Opciones de selects (tipo)
    const optMap = I18N[LANG].tipo_opts;
    const selectedTipo = tipoSel.value || '';
    tipoSel.innerHTML = `
      <option value="">${optMap.blank}</option>
      <option value="Accidente">${optMap.Accidente}</option>
      <option value="Mecanico">${optMap.Mecanico}</option>
      <option value="Otro">${optMap.Otro}</option>
    `;
    tipoSel.value = selectedTipo;

    // Opciones heridos
    const hMap = I18N[LANG].heridos_opts;
    const selHeridos = heridosSel.value || '';
    heridosSel.innerHTML = `
      <option value="">${hMap.blank}</option>
      <option value="si">${hMap.si}</option>
      <option value="no">${hMap.no}</option>
    `;
    heridosSel.value = selHeridos;

    updatePhoneUI();
    updateMapLink($('#lat').value, $('#lng').value);

    document.querySelectorAll('.lang-btn').forEach(b=>{
      b.classList.toggle('active', b.dataset.lang === LANG);
    });
  }

  // === EVENTS ===
  document.querySelectorAll('.lang-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      LANG = btn.dataset.lang;
      localStorage.setItem('lang', LANG);
      applyLang();
    });
  });

  codeSelect.addEventListener('change', updatePhoneUI);
  telInput.addEventListener('input', updatePhoneUI);
  tipoSel.addEventListener('change', ()=>{ updateHeridos(); });

  $('#btnUbic').addEventListener('click', getLocation);

  window.addEventListener('load', ()=>{
    $('#requestId').value = uuid4();
    $('#timestamp').value = new Date().toISOString();
    applyLang();
    updateHeridos();
    getLocation();
  });

  // SUBMIT
  f.addEventListener('submit', async e=>{
    e.preventDefault();

    const localDigits = telInput.value.replace(/\D/g,'');
    if(!tipoSel.value){ setMsg(I18N[LANG].msgTipoReq,'err'); tipoSel.focus(); return; }
    if(tipoSel.value === 'Accidente' && !heridosSel.value){
      setMsg(I18N[LANG].msgHeridosReq,'err'); heridosSel.focus(); return;
    }
    if(!localDigits || !/^\d{6,11}$/.test(localDigits)){
      setMsg(I18N[LANG].msgTelReq,'err'); telInput.focus(); return;
    }

    setSendingState(true, I18N[LANG].sending);
    setMsg(I18N[LANG].msgPrep,'muted');

    const cc = codeSelect.value;
    const telefonoIntl = normalizePhone(localDigits, cc);

    const latV = $('#lat').value ? parseFloat($('#lat').value) : null;
    const lngV = $('#lng').value ? parseFloat($('#lng').value) : null;

    const payload = {
      requestId: $('#requestId').value || uuid4(),
      timestamp: new Date().toISOString(),
      nombre: $('#nombre').value.trim() || null,
      telefono: telefonoIntl,
      telefonoLocal: localDigits,
      codigoPais: cc,
      tipoEvento: tipoSel.value,
      HayHeridosTexto: heridosSel.value ? (heridosSel.value === 'si' ? I18N[LANG].heridos_opts.si : I18N[LANG].heridos_opts.no) : null,
      HayHeridosTextoEs: heridosSel.value ? (heridosSel.value === 'si' ? I18N.es.heridos_opts.si : I18N.es.heridos_opts.no) : null,
      HayHeridos: heridosSel.value ? (heridosSel.value === 'si') : null,
      detalle: $('#detalle').value.trim() || "",
      lat: latV,
      lng: lngV,
      mapaUrl: $('#mapaUrl').value || "",
      uiLang: LANG,
      userAgent: navigator.userAgent,
      online: navigator.onLine
    };

    const controller = new AbortController();
    const to = setTimeout(()=>controller.abort(), FETCH_TIMEOUT_MS);

    try{
      const res = await fetch(endpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "X-Request-Id": payload.requestId },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(to);
      if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status}: ${t||'sin detalle'}`); }
      setMsg(I18N[LANG].msgOk,'ok');
      setSendingState(false, I18N[LANG].sending);
      f.reset();
      $('#requestId').value = uuid4();
      $('#timestamp').value = new Date().toISOString();
      gpsStatus.textContent = I18N[LANG].gpsInit;
      updateMapLink(null,null);
      updatePhoneUI();
      updateHeridos();
    }catch(err){
      clearTimeout(to);
      console.error(err);
      setSendingState(false, I18N[LANG].sending);
      setMsg("No se pudo enviar. Verifica tu conexi√≥n y reintenta. / Could not send. Check your connection and try again.",'err');
    }
  });

  // Limpieza
  $('#btnLimpiar').addEventListener('click', ()=>{
    setMsg('', 'muted');
    gpsStatus.textContent = I18N[LANG].gpsInit;
    updateMapLink(null,null);
    updatePhoneUI();
    updateHeridos();
  });
  </script>
</body>
</html>
