<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reporte SOS</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--fg:#111;--bg:#fff;--accent:#277771;--muted:#666;--error:#b00020;--ok:#0a7d2f}
    @media (prefers-color-scheme: dark){
      :root{--fg:#eee;--bg:#111;--muted:#aaa}
      input,select,button,textarea{background:#1b1b1b;color:var(--fg);border-color:#333}
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--fg);max-width:640px;margin:24px auto;padding:0 16px;line-height:1.35}
    h1{font-size:1.4rem;margin:.5rem 0 1rem}
    form{border:1px solid #e6e6e6;border-radius:12px;padding:16px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    .req::after{content:" *";color:var(--accent);font-weight:700}
    input,select,button,textarea{width:100%;padding:12px;border:1px solid #d7d7d7;border-radius:10px;outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row-tel{display:grid;grid-template-columns:minmax(120px,160px) 1fr;gap:10px}
    .hint{font-size:.85rem;color:var(--muted);margin-top:4px}
    .actions{display:flex;gap:10px;align-items:center;margin-top:8px}
    .actions button{flex:1}
    .ghost{background:transparent;border-style:dashed}
    .badge{display:inline-block;font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid #e6e6e6;color:var(--muted)}
    #msg{margin-top:14px;font-weight:600}
    .ok{color:var(--ok)}
    .err{color:var(--error)}
    .muted{color:var(--muted)}
    .maplink{margin-top:6px;display:inline-block}
    .sr-only{position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden}
    .footer{margin-top:14px;font-size:.85rem;color:var(--muted)}
    .spinner{inline-size:1em;block-size:1em;border:.18em solid #ccc;border-right-color:transparent;border-radius:50%;display:inline-block;vertical-align:-.2em;animation:s 0.8s linear infinite}
    @keyframes s{to{transform:rotate(1turn)}}
  </style>
</head>
<body>
  <h1>Reportar evento SOS</h1>

  <p class="hint">Comparte tu ubicaci√≥n para enviar ayuda m√°s r√°pido. Tus datos se usar√°n solo para gestionar este reporte.</p>

  <form id="f" novalidate aria-describedby="formHint">
    <div class="sr-only" id="formHint">Todos los campos marcados con * son obligatorios.</div>

    <label for="nombre">Nombre</label>
    <input id="nombre" name="nombre" placeholder="Tu nombre" autocomplete="name" inputmode="text" maxlength="80"/>

    <label class="req">Tel√©fono</label>
    <div class="row-tel">
      <select id="codPais" name="codPais" aria-label="C√≥digo de pa√≠s">
        <option value="+595" selected>PY (+595)</option>
        <option value="+55">BR (+55)</option>
        <option value="+54">AR (+54)</option>
        <option value="+598">UY (+598)</option>
        <option value="+591">BO (+591)</option>
      </select>
      <input id="telefono" name="telefono" type="tel" placeholder="981 123 456" autocomplete="tel"
             required pattern="^\d{6,11}$" aria-describedby="telHint">
    </div>
    <div class="hint" id="telHint">
      Escribe solo el n√∫mero local (sin 0, sin +). Se marcar√° como <code id="phonePreview">+595 981 123 456</code>.
    </div>

    <label for="tipo" class="req">Tipo de evento</label>
    <select id="tipo" name="tipo" required>
      <option value="">Selecciona‚Ä¶</option>
      <option>Accidente</option>
      <option>Problema mec√°nico</option>
      <option>Otro</option>
    </select>

    <!-- Campo condicional: ¬øHay heridos? -->
    <div id="grupoHeridos" hidden>
      <label for="heridos" class="req">¬øHay heridos?</label>
      <select id="heridos" name="heridos" aria-live="polite">
        <option value="">Selecciona‚Ä¶</option>
        <option>Si</option>
        <option>No</option>
      </select>
    </div>

    <label for="detalle">Detalle (opcional)</label>
    <textarea id="detalle" name="detalle" rows="3" placeholder="Describe brevemente lo ocurrido (m√°x. 300 caracteres)" maxlength="300"></textarea>

    <div class="actions">
      <button type="button" id="btnUbic">üìç Obtener ubicaci√≥n</button>
      <span id="gpsStatus" class="badge">GPS: sin capturar</span>
    </div>

    <div class="row" aria-live="polite">
      <div>
        <label for="lat">Latitud (auto)</label>
        <input id="lat" name="lat" placeholder="Latitud" readonly inputmode="numeric">
      </div>
      <div>
        <label for="lng">Longitud (auto)</label>
        <input id="lng" name="lng" placeholder="Longitud" readonly inputmode="numeric">
      </div>
    </div>

    <a id="mapaLink" class="maplink muted" href="#" target="_blank" rel="noopener" hidden>Ver ubicaci√≥n en Google Maps ‚Üó</a>

    <div class="actions">
      <button type="submit" id="btnEnviar">Enviar</button>
      <button type="reset" class="ghost" id="btnLimpiar">Limpiar</button>
    </div>

    <p id="msg" role="status" aria-live="polite"></p>
    <input type="hidden" id="requestId">
    <input type="hidden" id="timestamp">
    <!-- mapaUrl para enviar al flujo -->
    <input type="hidden" id="mapaUrl">
  </form>

  <p class="footer">Si el formulario falla, llama al <strong>+595 XXX XXX</strong> o escribe por WhatsApp.</p>

  <script>
  // === CONFIG ===
  const endpoint = "PEGAR_AQUI_URL_DEL_FLOW"; // tu endpoint de Power Automate
  const FETCH_TIMEOUT_MS = 12000;
  const GPS_TIMEOUT_MS = 10000;
  const GPS_MAX_AGE_MS = 15000;

  // === HELPERS ===
  const $ = sel => document.querySelector(sel);
  const f = $('#f');
  const btnEnviar = $('#btnEnviar');
  const btnUbic = $('#btnUbic');
  const msg = $('#msg');
  const gpsStatus = $('#gpsStatus');
  const mapaLink = $('#mapaLink');
  const telInput = $('#telefono');
  const codeSelect = $('#codPais');
  const phonePreview = $('#phonePreview');
  const tipoSel = $('#tipo');
  const grupoHeridos = $('#grupoHeridos');
  const heridosSel = $('#heridos');
  const mapaUrlHidden = $('#mapaUrl');

  const HINTS = {
    '+595': '981 123 456',
    '+55': '11 91234 5678',
    '+54': '11 1234 5678',
    '+598': '92 123 456',
    '+591': '7 6123456'
  };

  function setMsg(text, kind=""){ msg.className = kind || "muted"; msg.textContent = text; }
  function setSendingState(s){ btnEnviar.disabled = s; btnUbic.disabled = s; btnEnviar.innerHTML = s ? '<span class="spinner"></span> Enviando‚Ä¶' : 'Enviar'; }
  function uuid4(){ return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=crypto.getRandomValues(new Uint8Array(1))[0]&15;const v=c==='x'?r:(r&0x3|0x8);return v.toString(16);}); }

  function normalizePhone(local, cc){
    let n = (local||'').replace(/\D/g,'').replace(/^0+/, '');
    return cc + n;
  }

  function updatePhoneUI(){
    const cc = codeSelect.value;
    const example = HINTS[cc] || '981 123 456';
    if(!telInput.value) telInput.placeholder = example;
    const digits = telInput.value.replace(/\D/g,'').replace(/^0+/, '');
    const pretty = digits.replace(/(\d{3,4})(?=\d)/g,'$1 ').trim();
    phonePreview.textContent = cc + ' ' + (pretty || example);
  }

  codeSelect.addEventListener('change', updatePhoneUI);
  telInput.addEventListener('input', updatePhoneUI);

  // Campo condicional "¬øHay heridos?"
  function updateHeridos(){
    const esAccidente = (tipoSel.value.toLowerCase() === 'accidente');
    grupoHeridos.hidden = !esAccidente;
    heridosSel.required = esAccidente;
    if(!esAccidente){ heridosSel.value = ''; }
  }
  tipoSel.addEventListener('change', updateHeridos);

  // GEOLOCATION
  async function getLocation(){
    if(!('geolocation' in navigator)){ gpsStatus.textContent='GPS: no disponible'; setMsg('Tu navegador no permite geolocalizaci√≥n.','err'); return; }
    gpsStatus.textContent='GPS: buscando‚Ä¶'; setMsg('Obteniendo ubicaci√≥n‚Ä¶','muted');
    const opts = { enableHighAccuracy:true, timeout:GPS_TIMEOUT_MS, maximumAge:GPS_MAX_AGE_MS };
    const p = new Promise((resolve,reject)=>{ navigator.geolocation.getCurrentPosition(resolve,reject,opts); });
    try{
      const pos = await p;
      const { latitude, longitude, accuracy } = pos.coords;
      $('#lat').value = latitude.toFixed(6);
      $('#lng').value = longitude.toFixed(6);
      gpsStatus.textContent = `GPS: OK (¬±${Math.round(accuracy)} m)`;
      updateMapLink($('#lat').value,$('#lng').value);
      setMsg('Ubicaci√≥n capturada correctamente.','ok');
    }catch(err){
      gpsStatus.textContent = 'GPS: error';
      setMsg('No se pudo obtener tu ubicaci√≥n. Puedes reintentar o enviar sin ubicaci√≥n.','err');
    }
  }

  function updateMapLink(lat,lng){
    if(lat && lng){
      const url = `https://www.google.com/maps?q=${lat},${lng}`;
      mapaLink.href = url;
      mapaLink.hidden = false;
      mapaLink.classList.remove('muted');
      mapaUrlHidden.value = url; // guardar para enviar al flujo
    }else{
      mapaLink.hidden = true;
      mapaUrlHidden.value = "";
    }
  }

  btnUbic.addEventListener('click', getLocation);

  // Intento autom√°tico al cargar
  window.addEventListener('load', ()=>{
    $('#requestId').value = uuid4();
    $('#timestamp').value = new Date().toISOString();
    updatePhoneUI();
    updateHeridos();
    getLocation();
  });

  // SUBMIT
  f.addEventListener('submit', async e=>{
    e.preventDefault();

    const localDigits = telInput.value.replace(/\D/g,'');
    if(!tipoSel.value){ setMsg('Selecciona el tipo de evento.','err'); tipoSel.focus(); return; }
    if(tipoSel.value.toLowerCase()==='accidente' && !heridosSel.value){
      setMsg('Indica si hay heridos.','err'); heridosSel.focus(); return;
    }
    if(!localDigits || !/^\d{6,11}$/.test(localDigits)){
      setMsg('Ingresa un n√∫mero local v√°lido (6 a 11 d√≠gitos).','err'); telInput.focus(); return;
    }

    setSendingState(true);
    setMsg('Preparando env√≠o‚Ä¶');

    const cc = codeSelect.value;
    const telefonoIntl = normalizePhone(localDigits, cc);

    const latV = $('#lat').value ? parseFloat($('#lat').value) : null;
    const lngV = $('#lng').value ? parseFloat($('#lng').value) : null;

    const payload = {
      requestId: $('#requestId').value || uuid4(),
      timestamp: new Date().toISOString(),
      nombre: $('#nombre').value.trim() || null,
      telefono: telefonoIntl,
      telefonoLocal: localDigits,
      codigoPais: cc,
      tipoEvento: tipoSel.value,
      HayHeridosTexto: heridosSel.value || null, // si tu columna es de Texto
      HayHeridos: heridosSel.value ? (heridosSel.value.toLowerCase()==='si') : null, // si usas S√≠/No
      detalle: $('#detalle').value.trim() || "", // opcional: cadena vac√≠a mejor que null
      lat: latV,
      lng: lngV,
      mapaUrl: mapaUrlHidden.value || "", // <-- link listo para SharePoint
      userAgent: navigator.userAgent,
      online: navigator.onLine
    };

    const controller = new AbortController();
    const to = setTimeout(()=>controller.abort(), FETCH_TIMEOUT_MS);

    try{
      const res = await fetch(endpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "X-Request-Id": payload.requestId },
        body: JSON.stringify(payload),
        signal: controller.signal
      });
      clearTimeout(to);
      if(!res.ok){ const t = await res.text().catch(()=> ''); throw new Error(`HTTP ${res.status}: ${t||'sin detalle'}`); }
      setMsg('¬°Reporte enviado correctamente! La ayuda va en camino.','ok');
      setSendingState(false);
      f.reset();
      $('#requestId').value = uuid4();
      $('#timestamp').value = new Date().toISOString();
      gpsStatus.textContent = 'GPS: sin capturar';
      updateMapLink(null,null);
      updatePhoneUI();
      updateHeridos();
    }catch(err){
      clearTimeout(to);
      console.error(err);
      setSendingState(false);
      setMsg('No se pudo enviar. Verifica tu conexi√≥n y reintenta. Si persiste, llama al n√∫mero de emergencia.','err');
    }
  });

  // Limpieza
  $('#btnLimpiar').addEventListener('click', ()=>{
    setMsg('Formulario limpiado.','muted');
    gpsStatus.textContent = 'GPS: sin capturar';
    updateMapLink(null,null);
    updatePhoneUI();
    updateHeridos();
  });
  </script>
</body>
</html>
